<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumen de Resultados</title>
    
    <link rel="stylesheet" href="css/resumen.css"> 
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="icon" href="Imagenes/logo.jpg" type="image/png">
    
    <style>
        /* Estilos para la tarjeta mejorada */
        .card-puntaje {
            text-align: center; 
            padding: 30px 20px; 
            color: white; 
            border-radius: 15px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
            position: relative;
        }

        /* 1. EL BADGE DE NIVEL */
        .nivel-badge {
            background: rgba(255, 255, 255, 0.25); 
            color: white; 
            padding: 8px 25px; 
            border-radius: 50px; 
            text-transform: uppercase; 
            font-weight: 800; 
            font-size: 1.6rem; 
            display: inline-block; 
            margin-bottom: 15px; 
            letter-spacing: 1.5px; 
            backdrop-filter: blur(5px); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* 2. EL N√öMERO GIGANTE (EL PROTAGONISTA) */
        .big-number {
            font-size: 3.8rem; 
            font-weight: 800; 
            line-height: 1; 
            margin: 5px 0 5px 0; 
            text-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* 3. TEXTO DE CONTEXTO */
        .score-subtext {
            font-size: 1.1rem; 
            opacity: 0.9; /* Un poco m√°s suave para no competir con el grande */
            margin-top: 5px;
            margin-bottom: 25px;
            font-weight: 400;
        }

        /* USAMOS EL ID Y !IMPORTANT PARA EL M√ÅXIMO */
        #lblMaximo {
            font-size: 1.5rem !important; 
            font-weight: 800 !important;
            opacity: 1 !important; 
            vertical-align: middle;
            margin: 0 6px;
            position: relative;
            top: -2px;
            color: #ffffff;
            text-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* 4. BARRA DE PROGRESO */
        .progress-track {
            background: rgba(255, 255, 255, 0.2); 
            height: 12px; 
            border-radius: 10px; 
            width: 100%; 
            max-width: 280px; 
            margin: 0 auto 20px auto; 
            overflow: hidden; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .progress-fill {
            height: 100%; 
            background: white; 
            width: 0%; 
            border-radius: 10px; 
            transition: width 1.5s ease-out; 
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        .mensaje-score { font-weight: 500; line-height: 1.1; font-size: 1rem; }

        /* Estilo para el puntaje obtenido (Grande y oscuro) */
.score-actual {
    font-size: 1.1rem;
    font-weight: 800;
    color: #2c3e50;
}

/* Estilo para el total (Peque√±o y gris) */
.score-divider {
    color: #aaa;
    font-weight: 400;
    font-size: 0.9rem;
    margin: 0 2px;
}

.score-max {
    color: #888;
    font-size: 0.9rem;
    font-weight: 500;
}
    </style>
</head>
<body>

    <div class="resumen-container">
        
        <div class="header-resumen">
            <img src="Imagenes/logo.png" alt="Logo" class="logo" />
            <div style="margin-left: 230px;"> 
                <h1>üìä Resultados del Diagn√≥stico</h1>
                <p class="intro">Desglose detallado de la evaluaci√≥n institucional.</p>
            </div>
        </div>

        <div class="dashboard-grid">
            
            <div class="dashboard-left">
                
                <div id="cardPuntaje" class="card-puntaje">
                    
                    <div id="lblNivel" class="nivel-badge">Cargando...</div>
                    
                    <div class="big-number" id="lblPuntaje">--</div>
                    
                    <div class="score-subtext">
                        puntos de <strong id="lblMaximo">--</strong> posibles
                    </div>

                    <div class="progress-track">
                        <div class="progress-fill" id="barraProgreso"></div>
                    </div>
                    
                    <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">
                    
                    <p class="mensaje-score" id="lblMensaje">Calculando resultados...</p>
                </div>

                <div class="actions-panel">
                    <button onclick="window.print()" class="btn-imprimir">üñ®Ô∏è Imprimir Reporte</button>
                    <a href="login.html" class="link-salir">Salir</a>
                </div>
            </div>

            <div class="dashboard-right">
                <h3 class="titulo-seccion">Desglose por Secci√≥n</h3>
                <div class="tabla-container">
                    <table class="tabla-desglosada">
                        <thead>
                            <tr>
                                <th>Secci√≥n</th>
                                <th style="text-align: right;">Puntos</th>
                            </tr>
                        </thead>
                        <tbody id="tablaBody">
                            </tbody>
                    </table>
                </div>
            </div>

        </div> 
    </div>

    <script>
        const API_URL = 'https://api-cuestionario.onrender.com';

        async function cargarResumen() {
            const idUsuario = localStorage.getItem('idUsuario');
            if(!idUsuario) { 
                alert("No hay sesi√≥n activa."); 
                window.location.href = 'login.html'; 
                return; 
            }

            try {
                const response = await fetch(`${API_URL}/resumen/${idUsuario}`);
                const data = await response.json();

                if(data.error) { alert(data.error); return; }

                // --- ACTUALIZACI√ìN DE DATOS ---

                // 1. Color de Fondo
                document.getElementById('cardPuntaje').style.background = data.color;

                // 2. Animaci√≥n del N√∫mero Grande
                animarNumero('lblPuntaje', 0, data.total, 1500);
                
                // 3. Texto del M√°ximo
                document.getElementById('lblMaximo').innerText = data.maximo;
                
                // 4. Nivel (Badge arriba)
                document.getElementById('lblNivel').innerText = `${data.nivel} (${data.porcentaje}%)`;
                
                // 5. Mensaje
                document.getElementById('lblMensaje').innerText = data.mensaje;

                // 6. Animaci√≥n de la Barra de Progreso
                setTimeout(() => {
                    document.getElementById('barraProgreso').style.width = `${data.porcentaje}%`;
                }, 300);

                // --- TABLA CON TOTALES ---
                const tbody = document.getElementById('tablaBody');
                tbody.innerHTML = '';
                
                const nombresSecciones = {
                    1: "Identificaci√≥n",
                    2: "Gesti√≥n Institucional",
                    3: "Caracterizaci√≥n del Acervo",
                    4: "Inventario, catalogaci√≥n y documentaci√≥n",
                    5: "Gesti√≥n de informaci√≥n y software",
                    6: "Recursos Humanos",
                    7: "Infraestructura Tecnol√≥gica",
                    8: "Procesos de gesti√≥n de colecciones",
                    9: "Servicios"
                };

                // ‚ö†Ô∏è IMPORTANTE: AQU√ç DEBES PONER EL VALOR M√ÅXIMO DE CADA SECCI√ìN
                // Suma los puntos de las preguntas de cada secci√≥n y ponlos aqu√≠.
                const MAXIMOS_POR_SECCION = {
                    1: "0",  // Ejemplo: La secci√≥n 1 vale 15 puntos 
                    2: 5, 
                    3: 20,
                    4: 25,
                    5: 81, // Si no sabes el m√°ximo pon "var√≠a"
                    6: 40,
                    7: 5,
                    8: 7,
                    9: 4
                    //Total: 106 checar las preguntas de la seccion 5 ya que alli suman mas de 100 puntos
                    // La suma de todo esto deber√≠a dar 187 (tu m√°ximo total)
                };

                Object.keys(data.secciones).sort((a,b) => a-b).forEach(sec => {
                    if(sec === 'Otra' && data.secciones[sec] === 0) return;
                    
                    const tr = document.createElement('tr');
                    const nombreSec = nombresSecciones[sec] || 'General';
                    const puntajeObtenido = data.secciones[sec];
                    const puntajeMaximo = MAXIMOS_POR_SECCION[sec] || '?'; // Si no lo defines pone '?'

                    tr.innerHTML = `
                        <td>
                            <div style="font-weight:600; color:#444;">${sec}. ${nombreSec}</div>
                        </td>
                        <td class="col-puntos">
                            <span class="score-actual">${puntajeObtenido}</span>
                            <span class="score-divider">/</span>
                            <span class="score-max">${puntajeMaximo}</span>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (error) { console.error(error); }
        }

        function animarNumero(id, start, end, duration) {
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
        
        document.addEventListener('DOMContentLoaded', cargarResumen);
    </script>
</body>
</html>