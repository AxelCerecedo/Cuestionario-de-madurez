<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumen de Resultados</title>
    
    <link rel="stylesheet" href="css/resumen.css"> 
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="Imagenes/logo.jpg" type="image/png">
    
    <style>
        /* =========================================
           1. ESTILOS TARJETA IZQUIERDA (Transl√∫cida)
           ========================================= */
        .card-puntaje {
            text-align: center; 
            padding: 40px 30px; 
            color: white; 
            border-radius: 15px; 
            
            /* Efecto Vidrio (Glassmorphism) */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

        .nivel-badge {
            background: rgba(255, 255, 255, 0.25); 
            color: white; 
            padding: 10px 30px; 
            border-radius: 50px; 
            text-transform: uppercase; 
            font-weight: 800; 
            font-size: 1.8rem; 
            display: inline-block; 
            margin-bottom: 20px; 
            letter-spacing: 1.5px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .mensaje-final {
            font-size: 1.1rem;
            line-height: 1.6;
            font-weight: 400;
            opacity: 0.95;
            max-width: 90%;
        }

        /* =========================================
           2. ESTILOS TABLA DERECHA (Acorde√≥n)
           ========================================= */
        .tabla-container {
            overflow-x: hidden;
        }

        .tabla-desglosada {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px; /* Espacio entre filas */
        }

        .tabla-desglosada th {
            text-align: left;
            padding: 10px;
            color: #666;
            font-size: 0.9rem;
            border-bottom: 2px solid #ddd;
        }

        /* Fila Principal (Visible) */
        .fila-seccion {
            background: #fff;
            transition: all 0.2s ease;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .fila-seccion:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .fila-seccion td {
            padding: 15px 15px;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }
        .fila-seccion td:first-child {
            border-left: 1px solid #eee;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        .fila-seccion td:last-child {
            border-right: 1px solid #eee;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            text-align: right;
        }

        /* Sem√°foro (Cuadrito de color) */
        .indicador-color {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 4px;
            margin-right: 15px;
            vertical-align: middle;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .texto-seccion {
            display: inline-block;
            font-weight: 600;
            color: #34495e;
            vertical-align: middle;
            font-size: 1rem;
        }

        /* Flecha */
        .btn-toggle {
            background: none;
            border: none;
            color: #95a5a6;
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }
        /* Rotaci√≥n al estar activo */
        .fila-seccion.activa .btn-toggle {
            transform: rotate(180deg);
            color: #2c3e50;
        }

        /* Fila de Detalle (Oculta) */
        .fila-detalle {
            display: none;
        }
        .fila-detalle.visible {
            display: table-row;
            animation: slideDown 0.3s ease-out forwards;
        }

        .contenido-detalle {
            background-color: #fcfcfc;
            padding: 20px 25px 20px 45px; /* Indentaci√≥n visual */
            border-left: 4px solid #eee; /* L√≠nea gu√≠a */
            font-size: 0.95rem;
            color: #555;
            line-height: 1.6;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
            border-radius: 0 0 8px 8px;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Botones de Acci√≥n */
        .btn-correo {
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            font-weight: 600;
            transition: background 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-correo:hover { background-color: #34495e; }
        .btn-correo:disabled { background-color: #95a5a6; cursor: wait; }

        .btn-imprimir {
            background-color: #fff;
            color: #2c3e50;
            border: 2px solid #2c3e50;
            padding: 10px;
            width: 100%;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-imprimir:hover { background-color: #f0f0f0; }

    </style>
</head>
<body>

    <div class="resumen-container">
        
        <div class="header-resumen">
            <img src="Imagenes/logo.png" alt="Logo" class="logo" />
            <div style="margin-left: 230px;"> 
                <h1>üìä Resultados del Diagn√≥stico</h1>
                <p class="intro">Informe ejecutivo de evaluaci√≥n y recomendaciones.</p>
            </div>
        </div>

        <div class="dashboard-grid">
            
            <div class="dashboard-left">
                
                <div id="cardPuntaje" class="card-puntaje">
                    <div id="lblNivel" class="nivel-badge">Cargando...</div>
                    
                    <hr style="width: 60%; border: 0; border-top: 1px solid rgba(255,255,255,0.4); margin: 25px 0;">
                    
                    <p class="mensaje-final">
                        Agradecemos su participaci√≥n en este diagn√≥stico.<br><br>
                        Hemos analizado la informaci√≥n proporcionada para generar las recomendaciones detalladas que encontrar√° a continuaci√≥n.
                    </p>
                </div>

                <div class="actions-panel">
                    <button onclick="window.print()" class="btn-imprimir">
                        <i class="fas fa-print"></i> Imprimir Reporte
                    </button>
                    
                    <button id="btnEnviarCorreo" onclick="enviarCorreo()" class="btn-correo">
                        <i class="fas fa-envelope"></i> Enviar a mi correo
                    </button>

                    <a href="login.html" class="link-salir" style="margin-top: 15px; display:block; text-align:center; color: #7f8c8d; text-decoration: none; font-size: 0.9em;">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                    </a>
                </div>
            </div>

            <div class="dashboard-right">
                <h3 class="titulo-seccion">Desglose por secciones y recomendaciones</h3>
                <div class="tabla-container">
                    <table class="tabla-desglosada">
                        <thead>
                            <tr>
                                <th>√Årea Evaluada</th>
                                <th style="text-align: right; width: 50px;">Ver</th>
                            </tr>
                        </thead>
                        <tbody id="tablaBody">
                            </tbody>
                    </table>
                </div>
            </div>

        </div> 
    </div>

    <script>
        const API_URL = 'https://api-cuestionario.onrender.com';

        // Puntos m√°ximos para c√°lculo de porcentaje
        const MAXIMOS_POR_SECCION = {
            1: 0, 
            2: 5, 3: 21, 4: 34, 5: 81, 6: 40, 7: 5, 8: 7, 9: 4
        };

        const NOMBRES_SECCIONES = {
            1: "Identificaci√≥n de la Instituci√≥n", 
            2: "Gesti√≥n Institucional", 
            3: "Caracterizaci√≥n del Acervo",
            4: "Inventario y Catalogaci√≥n", 
            5: "Gesti√≥n de informaci√≥n", 
            6: "Recursos Humanos",
            7: "Infraestructura Tecnol√≥gica", 
            8: "Normatividad y Procesos", 
            9: "Servicios"
        };

        // =========================================================
        // 1. FUNCI√ìN HELPER: HEX A RGBA (Para transparencia)
        // =========================================================
        function hexToRgba(hex, alpha) {
            if (!hex || !hex.startsWith('#')) return 'rgba(108, 117, 125, 0.85)'; // Fallback gris
            
            hex = hex.replace('#', '');
            if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
            
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // =========================================================
        // 2. FUNCI√ìN PRINCIPAL DE CARGA
        // =========================================================
        async function cargarResumen() {
            const idUsuario = localStorage.getItem('idUsuario');
            if(!idUsuario) { 
                window.location.href = 'login.html'; 
                return; 
            }

            try {
                const response = await fetch(`${API_URL}/resumen/${idUsuario}`);
                const data = await response.json();

                if(data.error) { alert(data.error); return; }

                // --- A. TARJETA IZQUIERDA ---
                // Usamos 0.85 de opacidad para que sea transl√∫cido pero legible
                const colorTranslucido = hexToRgba(data.color, 0.85);
                document.getElementById('cardPuntaje').style.background = colorTranslucido;
                document.getElementById('lblNivel').innerText = data.nivel;

                // --- B. TABLA DERECHA (DESGLOSE) ---
                const tbody = document.getElementById('tablaBody');
                tbody.innerHTML = '';
                
                Object.keys(data.secciones).sort((a,b) => a-b).forEach(sec => {
                    const numSec = parseInt(sec);
                    if(isNaN(numSec)) return; 

                    const puntajeObtenido = data.secciones[sec];
                    const puntajeMaximo = MAXIMOS_POR_SECCION[sec] || 1; 
                    
                    let colorCuadrito = '#6c757d'; 
                    let recomendacionTexto = "";

                    // L√ìGICA DE TEXTOS PROFESIONALES
                    if (numSec === 1) {
                        colorCuadrito = '#28a745'; // Azul
                        recomendacionTexto = "‚ÑπÔ∏è <b>Informaci√≥n General:</b> Esta secci√≥n contiene los datos de identificaci√≥n. Verifique peri√≥dicamente que los contactos y la direcci√≥n se mantengan actualizados.";
                    } else {
                        const porcentaje = (puntajeObtenido / puntajeMaximo) * 100;
                        
                        if (porcentaje >= 80) {
                            colorCuadrito = '#28a745'; // Verde
                            recomendacionTexto = "‚úÖ <b>Nivel Consolidado:</b> La instituci√≥n cumple satisfactoriamente con los est√°ndares recomendados. El objetivo ahora debe ser la mejora continua, la actualizaci√≥n tecnol√≥gica y la documentaci√≥n de estas buenas pr√°cticas.";
                        } else if (porcentaje >= 50) {
                            colorCuadrito = '#ffc107'; // Amarillo
                            recomendacionTexto = "‚ö†Ô∏è <b>Nivel en Desarrollo:</b> Existen capacidades operativas funcionales, pero se detectaron brechas en la normativa o infraestructura. Se recomienda formalizar los procedimientos internos y gestionar recursos para fortalecer esta √°rea.";
                        } else {
                            colorCuadrito = '#dc3545'; // Rojo
                            recomendacionTexto = "üõë <b>Atenci√≥n Prioritaria:</b> Se identificaron carencias cr√≠ticas del acervo.";
                        }
                    }

                    // --- GENERACI√ìN DE HTML ---
                    
                    // 1. Fila Principal (Clickeable)
                    const trPrincipal = document.createElement('tr');
                    trPrincipal.className = 'fila-seccion';
                    trPrincipal.onclick = () => toggleDetalle(sec);

                    trPrincipal.innerHTML = `
                        <td>
                            <span class="indicador-color" style="background-color: ${colorCuadrito};"></span>
                            <span class="texto-seccion">${sec}. ${NOMBRES_SECCIONES[sec] || 'General'}</span>
                        </td>
                        <td>
                            <button class="btn-toggle" id="btn-${sec}">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </td>
                    `;

                    // 2. Fila Detalle (Oculta)
                    const trDetalle = document.createElement('tr');
                    trDetalle.id = `detalle-${sec}`;
                    trDetalle.className = 'fila-detalle';
                    trDetalle.innerHTML = `
                        <td colspan="2" style="padding: 0; border: none;">
                            <div class="contenido-detalle">
                                ${recomendacionTexto}
                            </div>
                        </td>
                    `;

                    tbody.appendChild(trPrincipal);
                    tbody.appendChild(trDetalle);
                });

            } catch (error) { 
                console.error(error);
                alert("Error de conexi√≥n al cargar resumen.");
            }
        }

        // =========================================================
        // 3. FUNCIONES DE INTERACCI√ìN
        // =========================================================
        
        function toggleDetalle(id) {
            const filaDetalle = document.getElementById(`detalle-${id}`);
            const btn = document.getElementById(`btn-${id}`);
            const filaPrincipal = btn.closest('tr');

            // Cerrar otros (Efecto Acorde√≥n √önico - Opcional)
            document.querySelectorAll('.fila-detalle').forEach(el => {
                if (el.id !== `detalle-${id}`) el.classList.remove('visible');
            });
            document.querySelectorAll('.fila-seccion').forEach(el => {
                if (el !== filaPrincipal) el.classList.remove('activa');
            });

            // Toggle actual
            if (filaDetalle.classList.contains('visible')) {
                filaDetalle.classList.remove('visible');
                filaPrincipal.classList.remove('activa');
            } else {
                filaDetalle.classList.add('visible');
                filaPrincipal.classList.add('activa');
            }
        }

        async function enviarCorreo() {
            const idUsuario = localStorage.getItem('idUsuario');
            const btn = document.getElementById('btnEnviarCorreo');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

            try {
                const response = await fetch(`${API_URL}/api/enviar-correo-resultados`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idUsuario: idUsuario })
                });

                const resultado = await response.json();

                if (response.ok) {
                    Swal.fire({
                        title: '¬°Correo Enviado!',
                        text: `El reporte ha sido enviado a su correo electr√≥nico registrado.`,
                        icon: 'success',
                        confirmButtonColor: '#7c1225'
                    });
                    btn.innerHTML = '<i class="fas fa-check"></i> Enviado';
                } else {
                    throw new Error(resultado.error || 'Error del servidor');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'No se pudo enviar el correo en este momento.', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-envelope"></i> Enviar a mi correo';
            }
        }
        
        // Inicializar al cargar
        document.addEventListener('DOMContentLoaded', cargarResumen);
    </script>
</body>
</html>